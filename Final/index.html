<!DOCTYPE html>
<html>
    <head>
        <title>Final</title>

        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"integrity="sha384-o/2yZuJZWGJ4s/adjxVW71R+EO/LyCwdQfP5UWSgX/w87iiTXuvDZaejd3TsN7mf"crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"integrity="sha384-okbbMvvx/qfQkmiQKfd5VifbKZ/W8p1qIsWvE1ROPUfHWsDcC8/BnHohF7vPg2T6"crossorigin=""></script>
        
        <!--SEARCH-->
        <script src="https://dsps.lib.uiowa.edu/placing/public/fuse-1.2.1/fuse.min.js"></script>
        <script src="https://dsps.lib.uiowa.edu/placing/public/leafletFuseSearch-noVersion/leafletfuse.js"></script>
        <link rel="stylesheet" href="https://dsps.lib.uiowa.edu/placing/public/leafletFuseSearch-noVersion/leafletfuse.css" type="text/css"/>
        <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
        <script src="https://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>

        <!--DATA-->
        <script src="https://japotter1.github.io/web-mapping/Final/vector_layers/buildings.js"></script>
        <script src="https://japotter1.github.io/web-mapping/Final/vector_layers/landuse.js"></script>
        <script src="https://japotter1.github.io/web-mapping/Final/vector_layers/rivers.js"></script>
        <script src="https://japotter1.github.io/web-mapping/Final/vector_layers/roads.js"></script>
        <script src="https://japotter1.github.io/web-mapping/Final/vector_layers/stations.js"></script>
        <script src="https://japotter1.github.io/web-mapping/Final/vector_layers/transit_lines.js"></script>
        <style type="text/css">body {margin: 0;padding: 0;} html, body, #map{width: 100%;height: 100%;}</style>
    </head>
    <body>
        <div id="map"></div>
        <script>

        // MAP
        var map = L.map('map', {attributionControl: false}).setView([-4.348, -42.7703], 14);
        L.control.attribution({prefix: false}).addTo(map);

        // TILES
        var base_tiles = L.tileLayer('https://japotter1.github.io/web-mapping/Final/base_tiles/{z}/{x}/{y}.png', {minZoom: 12, maxZoom: 18, tms: false, attribution: 'Created by QGIS'}).addTo(map);
        var transit_tiles = L.tileLayer('https://japotter1.github.io/web-mapping/Final/transit_tiles/{z}/{x}/{y}.png', {minZoom: 12, maxZoom: 18, tms: false, attribution: 'Created by QGIS'});

        // FEATURES

        // Landuse
        function getLanduseType(type) {
            switch (type) {
                case "POI": return "Point of Interest";
                default: return type;
            }
        }

        var landuse_popups = function(feature, layer) {
            if (feature.properties && feature.properties['Name'] != null) {
                var prop = feature.properties;
                var popup = '<h3 style=\"line-height: 0.8\">'+prop['Name']+'</h3><hr>'
                    + '<b>Type: </b>' + getLanduseType(prop['Type']);
                feature.layer = layer;
                layer.bindPopup(popup, {maxWidth: 300});
            } else {
                layer.options.interactive = false;
            }
        }

        var landuse_l = new L.geoJson(landuse, {
            onEachFeature: landuse_popups,
            style: {
                    color: '#FFFFFF',
                    opacity: 0,
                    weight: 2,
                    fillColor: '#FFFFFF',
                    fillOpacity: 0,
            }
        }).addTo(map);

        // Buildings
        var building_popups = function(feature, layer) {
            if (feature.properties) {
                var prop = feature.properties;
                var popup = '<h3 style=\"line-height: 0.8\">' + ((prop['Name'] != null) ? prop['Name'] : ((prop['Type'] == 'station') ? 'Station' : 'Building')) + '</h3>'
                    + ((prop['Number'] != null) ? '<hr>' + prop['Number'] + ' ' + prop['Street'] : '');
                feature.layer = layer;
                layer.bindPopup(popup, {maxWidth: 300});
            }
        }

        var buildings_l = new L.geoJson(buildings, {
            onEachFeature: building_popups,
            style: {
                    color: '#FFFFFF',
                    opacity: 0,
                    weight: 2,
                    fillColor: '#FFFFFF',
                    fillOpacity: 0,
            }
        }).addTo(map);

        // Roads
        function getRoadType(type) {
            switch (type) {
                case 1: return "Major Highway";
                case 2: return "Secondary Highway";
                case 3: return "Major Road";
                case 4: return "Secondary Road";
                case 5: return "Local Road";
                case 6: return "Major Highway Ramp";
                case 7: return "Secondary Highway Ramp";
                case 8: return "Major Service Road";
                case 9: return "Alley/Minor Service";
                default: return "Other";
            }
        }

        var road_popups = function(feature, layer) {
            if (feature.properties) {
                var prop = feature.properties;
                var popup = ((prop['Name'] != null) ? '<h3 style=\"line-height: 0.8\">'+prop['Name']+'</h3><hr>':'')
                    +((prop['Route'] != null) ? '<b>Route '+prop['Route']+'</b><br>' : '')
                    +'<b>Type: </b>' + ((prop['Type'] != null) ? getRoadType(prop['Type']) : prop['Nonroad'])
                    +((prop['One_Way'] != null) ? '<br><b>One-Way</b>':'');
                feature.layer = layer;
                layer.bindPopup(popup, {maxWidth: 300});
            }
        };

        var roads_l = new L.geoJson(roads, {
            onEachFeature: road_popups,
            style: {
                    color: '#FFFFFF',
                    opacity: 0,
                    weight: 14
            }
        }).addTo(map);

        // Transit Lines
        function getTransitType(type) {
            switch (type) {
                case "CR": return "Commuter Rail";
                default: return type;
            }
        }

        var transit_popups = function(feature, layer) {
            if (feature.properties && feature.properties['Type'] != 'Transfer') {
                var prop = feature.properties;
                var popup = ((prop['Route'] != null) ? '<h3 style=\"line-height: 0.8; color:' + prop['LineCol'] + '\">'
                    + prop['Route']
                    + ((prop['Route2'] != null) ? ', ' + prop['Route2'] : '')
                    + ((prop['Route3'] != null) ? ', ' + prop['Route3'] : '')
                    + '</h3><hr>' : '')
                    + '<b>Type:</b> ' + getTransitType(prop['Type'])
                    + ((prop['Abvground'] != null) ? ' (Elevated)': '');
                feature.layer = layer;
                layer.bindPopup(popup, {maxWidth: 300});
            } else {
                layer.options.interactive = false;
            }
        }

        var transit_lines_l = new L.geoJson(transit_lines, {
            onEachFeature: transit_popups,
            style: {
                    color: '#FFFFFF',
                    opacity: 0,
                    weight: 10
            }
        });

        // Stations
        function getLineType(type) {
            switch (type) {
                case "CR_E": return "Commuter Rail - Express/Transfer";
                case "CR_L": return "Commuter Rail - Local";
                case "Metro_E": return "Metro - Express/Transfer";
                case "Metro_L": return "Metro - Local";
                case "RR_X": return "Railroad Crossing";
                default: return type;
            }
        }

        var station_popups = function(feature, layer) {
            if (feature.properties && feature.properties['Name'] != null) {
                var prop = feature.properties;
                var popup = '<h3 style=\"line-height: 0.8\">'+prop['Name']+'</h3><hr>'
                    + '<b>Type: </b>'+getLineType(prop['Type'])
                    + ((prop['Serves'] != null) ? '<br><b>Serves: </b>'+prop['Serves'] : '');
                feature.layer = layer;
                layer.bindPopup(popup, {maxWidth: 300});
            } else {
                layer.options.interactive = false;
            }
        };

        var stations_l = new L.geoJson(stations, {
            onEachFeature: station_popups,
            pointToLayer: function(feature, ll){
                return L.circleMarker(ll, {
                    color: '#FFFFFF',
                    opacity: 0,
                    weight: 2,
                    fillColor: '#FFFFFF',
                    fillOpacity: 0,
                    radius: 5
                });
            }
        });

        // LAYER CONTROL
        var basemaps = {
            'Roads': base_tiles,
            'Transit': transit_tiles
        };

        map.on('baselayerchange', function(event) {
            if (event.name == 'Roads') {
                map.addLayer(roads_l);
                map.removeLayer(transit_lines_l);
                map.removeLayer(stations_l);
            } else if (event.name == 'Transit') {
                map.addLayer(transit_lines_l);
                map.addLayer(stations_l);
                map.removeLayer(roads_l);
            }
        });

        L.control.layers(basemaps).addTo(map);

        // SEARCH

        var searchOptions = {
            position: "topleft",
            title: "Search",
            placeholder: "Example: Main St",
            maxResultLength: 10,
            caseSensitive: false,
            showInvisibleFeatures: true,
            threshold: 0.5,
            showResultFct: function(feature, container) {
                var props = feature.properties;
                var name = L.DomUtil.create('b', null, container);
                name.innerHTML = props.Name;
                container.appendChild(L.DomUtil.create('br', null, container));

                var cat = props.Name ? props.Name : props.Name,
                    info = cat;
                container.appendChild(document.createTextNode(info));
            }
        };

        var searchControl = L.control.fuseSearch(searchOptions);
        map.addControl(searchControl);
        searchControl.indexFeatures(roads, ['Name']);

        </script>
    </body>
</html>
